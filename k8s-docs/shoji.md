# 概要

## Kubernets のコンポーネント

- k8s はコントロールプレーンのコンポーネントとノードというマシン郡で構成されている。

### コントロールプレーンコンポーネント

- コントロールプレーンコンポーネントはシンプルにするために、すべてのコントロールプレーンコンポーネントを同じマシンで起動し、そのマシンではユーザーコンテナは実行しない
- kube-apiserver
  - k8s api を外部に提供する k8s のコントロールプレーンのコンポーネントで、コントロールプレーンのフロントエンドになる
- etcd
  - 一貫性、高可用性を持ったキーバリューストアで、k8s のすべてのクラスター情報の保存場所として利用される
- kube-scheduler
  - コントロールプレーン上で動作するコンポーネントで、新しく作られた Pod にノードが割り当てられているか監視し、割り当てられていなかった場合にその Pod を実行するノードを選択
  - Pod のリソース要求量やハード、ソフトの制約、アフィニティ、有効期限などを考慮して行われる
- kube-controller-manager
  - 下記の複数プロセスを実行
    - ノードコントローラー：ノードがダウンした場合の通知と対応を担当
    - Job コントローラー：単発タスクを表す Job オブジェクトを監視し、そのタスクを実行して完了させるための Pod を作成 (単発タスクはどういうものがあるのか)
    - EndpointSlice コントローラ：EndpointSlice オブジェクトを作成 (Service と Pod を紐づける)
    - ServiceAccount コントローラー：新規の名前空間に対してデフォルトの ServiceAccount を作成する
- cloud-controller-manager
  - クラウド上で実行する際に利用するもので、クラウドプロバイダー固有のコントローラーのみを実行する

### ノードコンポーネント

ノードコンポーネントはすべてのノードで実行され、稼働中の Pod 管理や k8s の実行環境を提供する。

- kubelet
  - クラスター内の各ノードで実行されるエージェントで、各コンテナが Pod で実行されていることを保証する
  - PodSpec のセットを取得し、それらの PodSpec に記述されているコンテナが正常に実行されている状態を保証する
- kube-proxy
  - kube-proxy はクラスター内の各 node で動作しているネットワークプロキシ
- コンテナランタイム
  - コンテナの実行を担当するソフトウェアで、Docker、containerd, CRI-O, すべての k8s CRI をサポート

### アドオン

アドオンはクラスターレベルの機能を提供しているので、アドオンのリソースで名前空間が必要なものは kube-system 名前空間に属する

- DNS
  - クラスター DNS 以外のアドオンは必須ではないが、すべての k8s クラスターはクラスター DNS を持つべき
  - クラスター DNS は環境内の他の DNS サーバーに加えて、k8s サービスの DNS レコードを提供する DNS サーバー
- WebUI
  - クラスター内で実行されているアプリケーションについて管理、トラブルシューティングができる Web ベース UI
- コンテナリソースの監視
- クラスターレベルのロギング

---

## Kubernetes API

k8s 内のオブジェクトの状態をクエリで操作できる。
k8s のコントロールプレーンの中核は API サーバーとそれが公開する HTTP API
ユーザー、クラスターのさまざまな部分、および外部コンポーネントはすべて API サーバーを介して互いに通信する。

### 永続性

- k8s は API リソースの観点からシリアル化された状態を etcd に書き込むことで保存する

### API の変更

k8s は既存のクライアントとの互換性を破壊しない、互換性を一定期間維持して、他のプロジェクトが適応する機会を提供する

---

# k8s オブジェクトを理解する

k8s は永続的なエンティティで、下記を表現可能

- どのようなコンテナ化されたアプリケーションが稼働しているか
- それらのアプリケーションが利用可能の名リソース
- アプリケーションがどのように振る舞うかのポリシー、再起動、アップグレードなど
  k8s は意図の記録で、一度オブジェクトを作成すると、k8s は常にそのオブジェクトが存在し続けるように動く

### オブジェクトの spec(仕様)と status(状態)

ほとんどの k8s オブジェクトはオブジェクトの設定を管理する 2 つの入れ子になったオブジェクトのフィールドを持っている (spec, status)
spec を持っているオブジェクトは作成時に spec を設定する必要があり、望ましい状態としてオブジェクトに持たせたい特徴を記述する必要がある
status オブジェクトは、オブジェクトの現在の状態を示し、k8s のコントロールプレーンは望ましい状態と status が一致するように管理をする

- 必須フィールド
  - apiVersion
  - kind: どの種類のオブジェクトを作成するのか
  - metadata: オブジェクトを一意に特定するための情報
  - spec: 望ましい状態

---

# Kubernetes オブジェクト管理

### 管理手法

- 命令型コマンド
  - 現行のオブジェクトを対象にし、開発用プロジェクトで利用される
- 命令型オブジェクト設定
  - 個々のファイルを対象にし、本番用で使われる
- 宣言型オブジェクト設定
  - ファイルのディレクトリを対象にし、本番用で使われる
